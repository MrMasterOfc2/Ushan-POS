<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHANDANA STORES - PRO POS</title>
    <style>
        /* --- 1. ‡∂∏‡∑ù‡∑É‡∑ä‡∂≠‡∂ª (CSS) - ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂≠‡∑í‡∂ª‡∂∫‡∂ö‡∂ß ‡∂ú‡∑ê‡∑Ö‡∂¥‡∑ô‡∂± ‡∂Ω‡∑ô‡∑É (Responsive) --- */
        :root {
            --main-blue: #1a237e;
            --success-green: #2e7d32;
            --error-red: #c62828;
            --light-gray: #f5f6fa;
            --text-primary: #000000;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f6fa;
            --border-color: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --discount-color: #ff5722;
        }

        .dark-mode {
            --main-blue: #3949ab;
            --success-green: #4caf50;
            --error-red: #ef5350;
            --light-gray: #1e1e1e;
            --text-primary: #ffffff;
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --border-color: #333;
            --shadow: rgba(255,255,255,0.1);
            --discount-color: #ff8a65;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* ‡∂â‡∑Ñ‡∑Ö ‡∂≠‡∑ì‡∂ª‡∑î‡∑Ä */
        header {
            background: var(--main-blue);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑ú‡∂ß‡∑É */
        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 10px;
            gap: 15px;
        }

        /* ‡∂∂‡∂©‡∑î ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä ‡∂á‡∂≠‡∑í ‡∂ö‡∑ú‡∂ß‡∑É (‡∑Ä‡∂∏‡∑ä ‡∂¥‡∑É) */
        .inventory-section {
            flex: 2;
            background: var(--bg-primary);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            padding: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
            transition: all 0.3s;
        }

        /* ‡∂∂‡∑í‡∂Ω ‡∂á‡∂≠‡∑í ‡∂ö‡∑ú‡∂ß‡∑É (‡∂Ø‡∂ö‡∑î‡∂´‡∑î ‡∂¥‡∑É) */
        .billing-section {
            flex: 1;
            background: var(--bg-primary);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-left: 5px solid var(--main-blue);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
            min-width: 340px;
            transition: all 0.3s;
        }

        /* ‡∑É‡∑ô‡∑Ä‡∑î‡∂∏‡∑ä ‡∂ö‡∑ú‡∂ß‡∑î‡∑Ä ‡∑É‡∑Ñ ‡∂∂‡∑ú‡∂≠‡∑ä‡∂≠‡∂∏‡∑ä */
        .search-bar {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--main-blue);
            box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.2);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-lock { 
            background: #ff9800; 
            color: white;
            border-color: #e68900;
        }
        .btn-unlock { 
            background: #4caf50; 
            color: white;
            border-color: #3d8b40;
        }
        .btn-pay { 
            background: var(--main-blue); 
            color: white; 
            width: 100%; 
            padding: 15px; 
            font-size: 18px;
            border-color: #0d47a1;
            margin-top: 10px;
        }
        .btn-dark-mode {
            background: #333;
            color: white;
            border-color: #222;
        }
        .btn-light-mode {
            background: #f5f5f5;
            color: #333;
            border-color: #ddd;
        }

        /* ‡∑Ä‡∂ú‡∑î‡∑Ä (Table) */
        .scroll-box {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--bg-primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-secondary);
            padding: 12px;
            position: sticky;
            top: 0;
            text-align: left;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        tr:hover { 
            background: var(--bg-secondary); 
            cursor: pointer; 
        }
        .selected-row { 
            background: rgba(57, 73, 171, 0.1) !important; 
            border-left: 3px solid var(--main-blue);
        }

        /* Popup ‡∑Ä‡∑í‡∂±‡∑ä‡∂©‡∑ù‡∑Ä */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .popup-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .popup-content h3 {
            margin-top: 0;
            color: var(--main-blue);
            text-align: center;
            margin-bottom: 20px;
        }

        .popup-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .popup-input:focus {
            outline: none;
            border-color: var(--main-blue);
            box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.2);
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .popup-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .btn-confirm { 
            background: var(--success-green); 
            color: white;
            border-color: #1b5e20;
        }
        .btn-cancel { 
            background: #757575; 
            color: white;
            border-color: #616161;
        }

        /* Cart item styling - Improved Layout */
        #cartList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s;
        }

        #cartList li:hover {
            background: var(--bg-secondary);
        }

        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            font-size: 15px;
        }

        .cart-item-price-block {
            text-align: right;
            min-width: 80px;
        }

        .original-price-strike {
            text-decoration: line-through;
            color: #888;
            font-size: 12px;
            display: block;
        }

        .discount-label {
            color: var(--discount-color);
            font-size: 12px;
            font-weight: bold;
            display: block;
        }

        .final-price-display {
            font-weight: bold;
            font-size: 15px;
        }

        /* Bill Summary Section */
        .bill-summary {
            padding: 15px 0;
            border-top: 2px dashed var(--border-color);
            margin-top: 10px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .summary-row.total {
            font-size: 22px;
            font-weight: bold;
            color: var(--main-blue);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .summary-row.discount-row {
            color: var(--discount-color);
        }

        /* Mobile ‡∂ë‡∂ö‡∂ö‡∂Ø‡∑ì ‡∂¥‡∑ô‡∂±‡∑î‡∂∏ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∑ì‡∂∏ */
        @media (max-width: 768px) {
            .main-wrapper { 
                flex-direction: column; 
                overflow-y: auto; 
            }
            .billing-section { 
                min-width: 100%; 
                height: 500px; 
            }
            .popup-content { 
                width: 90%; 
                padding: 20px; 
            }
            .header-controls {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
        }

        /* Theme toggle button */
        .theme-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Stats display */
        .stats-display {
            font-size: 14px;
            color: #ccff90;
            text-align: right;
        }

        /* Button icons */
        .btn-icon {
            font-size: 16px;
        }

        .remove-btn {
            color: var(--error-red);
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .remove-btn:hover {
            background: rgba(198, 40, 40, 0.1);
        }
    </style>
</head>
<body>

<header>
    <div style="font-size: 20px; font-weight: bold;">CHANDANA STORES</div>
    <div class="header-controls">
        <button class="theme-toggle" id="themeToggle" title="Dark/Light Mode">
            üåô
        </button>
        
        <div class="stats-display" id="stats">‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏: 0.00 | ‡∂Ω‡∑è‡∂∑‡∂∫: 0.00</div>
    </div>
</header>

<div class="main-wrapper">
    <section class="inventory-section">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="searchInput" class="search-bar" placeholder="‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∑ö ‡∂±‡∂∏ ‡∑É‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑Ñ‡∑ù Scan ‡∂ö‡∂ª‡∂±‡∑ä‡∂±..." onkeyup="searchItem()">
            <button id="lockBtn" class="btn btn-lock" onclick="handleSecurity()">
                <span class="btn-icon">üîí</span> Unlock
            </button>
        </div>

        <div class="scroll-box">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∑ö ‡∂±‡∂∏</th>
                        <th>‡∂∏‡∑í‡∂Ω</th>
                        <th>‡∑É‡∑ä‡∂ß‡∑ú‡∂ö‡∑ä</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody">
                    </tbody>
            </table>
        </div>
        <button class="btn" style="background: var(--success-green); color: white; margin-top: 15px; padding: 15px;" onclick="addToCart()">
            <span class="btn-icon">‚ûï</span> ‡∂ö‡∑è‡∂ª‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂Ø‡∑è‡∂±‡∑ä‡∂±
        </button>
    </section>

    <section class="billing-section">
        <h2 style="margin-top: 0;">‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∂∂‡∑í‡∂Ω</h2>
        <div class="scroll-box" id="cartContainer" style="background: var(--bg-secondary); border: none;">
            <ul id="cartList" style="list-style: none; padding: 0;"></ul>
        </div>

        <div style="margin-top: 10px;">
            <button class="btn" style="background: #607d8b; color: white; width: 100%; margin-bottom: 5px; border-color: #546e7a;" onclick="showDiscountPopup()">
                <span class="btn-icon">üí∞</span> ‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä (Discount)
            </button>
            
            <div id="billSummaryArea" class="bill-summary">
                <div class="summary-row">
                    <span>‡∂ã‡∂¥ ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä (Subtotal):</span>
                    <span id="subTotalDisplay">0.00</span>
                </div>
                <div class="summary-row discount-row" id="discountRow" style="display: none;">
                    <span>‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä (Discount):</span>
                    <span id="discountDisplay">-0.00</span>
                </div>
                <div class="summary-row total">
                    <span>‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä (Net Total):</span>
                    <span id="grandTotal">0.00</span>
                </div>
            </div>

            <button class="btn btn-pay" onclick="checkout()">
                <span class="btn-icon">üí≥</span> ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (PAY)
            </button>
        </div>
    </section>
</div>

<div id="itemNamePopup" class="popup-overlay">
    <div class="popup-content">
        <h3>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∑ö ‡∂±‡∂∏ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h3>
        <input type="text" id="newItemName" class="popup-input" placeholder="‡∂±‡∑Ä ‡∂±‡∂∏ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±">
        <div class="popup-buttons">
            <button class="btn-confirm" onclick="confirmItemNameChange()">‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
            <button class="btn-cancel" onclick="closeItemNamePopup()">‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        </div>
    </div>
</div>

<div id="discountPopup" class="popup-overlay">
    <div class="popup-content">
        <h3>‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h3>
        <input type="number" id="discountAmount" class="popup-input" placeholder="‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä ‡∂ª‡∑î‡∂¥‡∑í‡∂∫‡∂Ω‡∑ä (Rs)" min="0" step="0.01">
        <div class="popup-buttons">
            <button class="btn-confirm" onclick="confirmDiscount()">‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä ‡∂∫‡∑ú‡∂Ø‡∂±‡∑ä‡∂±</button>
            <button class="btn-cancel" onclick="closeDiscountPopup()">‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        </div>
    </div>
</div>

<div id="receiptPopup" class="popup-overlay">
    <div class="popup-content">
        <h3 style="color: var(--success-green);">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! ‚úì</h3>
        <div id="receiptDetails" style="max-height: 300px; overflow-y: auto; margin: 15px 0; padding-right: 10px; font-family: 'Courier New', monospace;">
            </div>
        <div class="popup-buttons">
            <button class="btn-confirm" onclick="closeReceiptPopup()">‡∑Ñ‡∂ª‡∑í (OK)</button>
        </div>
    </div>
</div>

<script>
    /* --- 2. ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑Ñ ‡∑Ä‡∑ê‡∂©‡∂ö‡∑ë‡∂Ω‡∑í (JavaScript) --- */

    let inventory = [];
    let cart = [];
    let isLocked = true;
    let selectedId = null;
    let totalIncome = 0;
    let totalProfit = 0;
    let itemToEdit = null;
    let discountItemIndex = null;
    let isDarkMode = false;
    let castConnected = false;
    let castDeviceName = null;

    // ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂∫‡∑ö‡∂Ø‡∑ì ‡∂∂‡∂©‡∑î 200 ‡∂ö‡∑ä ‡∑É‡∑ë‡∂Ø‡∑ì‡∂∏
    function initialize() {
        // Check for saved theme
        const savedTheme = localStorage.getItem('chandana_theme');
        if (savedTheme === 'dark') {
            enableDarkMode();
        } else {
            enableLightMode();
        }

        // Check for saved data
        const saved = localStorage.getItem('chandana_db');
        if (saved) {
            inventory = JSON.parse(saved);
        } else {
            for (let i = 1; i <= 200; i++) {
                inventory.push({
                    id: i,
                    name: "‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫ " + i,
                    cost: 100,
                    price: 150,
                    stock: 50
                });
            }
            saveToStorage();
        }
        renderTable();
    }

    // ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑ö‡∑Ä‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (Offline)
    function saveToStorage() {
        localStorage.setItem('chandana_db', JSON.stringify(inventory));
    }

    // Dark Mode ‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    function enableDarkMode() {
        document.body.classList.add('dark-mode');
        isDarkMode = true;
        document.getElementById('themeToggle').innerHTML = '‚òÄÔ∏è';
        document.getElementById('themeToggle').title = 'Light Mode';
        localStorage.setItem('chandana_theme', 'dark');
    }

    // Light Mode ‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    function enableLightMode() {
        document.body.classList.remove('dark-mode');
        isDarkMode = false;
        document.getElementById('themeToggle').innerHTML = 'üåô';
        document.getElementById('themeToggle').title = 'Dark Mode';
        localStorage.setItem('chandana_theme', 'light');
    }

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', function() {
        if (isDarkMode) {
            enableLightMode();
        } else {
            enableDarkMode();
        }
    });

    // ‡∑Ä‡∂ú‡∑î‡∑Ä ‡∂á‡∂≥‡∑ì‡∂∏
    function renderTable() {
        const body = document.getElementById('inventoryBody');
        body.innerHTML = inventory.map(item => `
            <tr onclick="selectRow(${item.id})" id="row-${item.id}">
                <td>${item.id}</td>
                <td onclick="openItemNamePopup(${item.id})">${item.name}</td>
                <td onclick="directEdit(${item.id}, 'price')">${item.price.toFixed(2)}</td>
                <td onclick="directEdit(${item.id}, 'stock')">${item.stock}</td>
            </tr>
        `).join('');
    }

    // ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏ ‡∂±‡∂∏ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß popup ‡∂ë‡∂ö ‡∂Ö‡∂ª‡∑í‡∂±‡∑ä‡∂±
    function openItemNamePopup(id) {
        if (isLocked) return;
        itemToEdit = id;
        let item = inventory.find(i => i.id === id);
        document.getElementById('newItemName').value = item.name;
        document.getElementById('itemNamePopup').style.display = 'flex';
        document.getElementById('newItemName').focus();
    }

    // ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏ ‡∂±‡∂∏ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    function confirmItemNameChange() {
        if (!itemToEdit) return;
        let newName = document.getElementById('newItemName').value.trim();
        if (newName) {
            let item = inventory.find(i => i.id === itemToEdit);
            item.name = newName;
            saveToStorage();
            renderTable();
            
            // Update cart if item is in cart
            cart.forEach(cartItem => {
                if (cartItem.id === itemToEdit) {
                    cartItem.name = newName;
                }
            });
            updateCartUI();
        }
        closeItemNamePopup();
    }

    // ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏ ‡∂±‡∂∏ popup ‡∑Ä‡∑É‡∂±‡∑ä‡∂±
    function closeItemNamePopup() {
        document.getElementById('itemNamePopup').style.display = 'none';
        itemToEdit = null;
    }

    // ‡∑É‡∑ô‡∑Ä‡∑ì‡∂∏ (Search)
    function searchItem() {
        let filter = document.getElementById('searchInput').value.toLowerCase();
        let rows = document.getElementById('inventoryBody').getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
        }
    }

    // ‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∂ö ‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ë‡∂ö (Security)
    function handleSecurity() {
        if (isLocked) {
            let pin = prompt("PIN ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (1234):");
            if (pin === "1234") {
                isLocked = false;
                document.getElementById('lockBtn').innerHTML = '<span class="btn-icon">üîì</span> Unlocked';
                document.getElementById('lockBtn').className = "btn btn-unlock";
            } else { 
                alert("‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í PIN ‡∂ë‡∂ö‡∂ö‡∑ä!");
            }
        } else {
            isLocked = true;
            document.getElementById('lockBtn').innerHTML = '<span class="btn-icon">üîí</span> Unlock';
            document.getElementById('lockBtn').className = "btn btn-lock";
        }
    }

    // ‡∂ö‡∑ô‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ ‡∂ë‡∂©‡∑í‡∂ß‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∂∏‡∑í‡∂Ω ‡∑É‡∑Ñ ‡∑É‡∑ä‡∂ß‡∑ú‡∂ö‡∑ä)
    function directEdit(id, field) {
        if (isLocked) return;
        let item = inventory.find(i => i.id === id);
        let currentValue = field === 'price' ? item[field].toFixed(2) : item[field];
        let newVal = prompt("‡∂±‡∑Ä ‡∂Ö‡∂ú‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:", currentValue);
        if (newVal !== null) {
            item[field] = parseFloat(newVal);
            saveToStorage();
            renderTable();
        }
    }

    // ‡∂¥‡∑ö‡∑Ö‡∑í‡∂∫‡∂ö‡∑ä ‡∂≠‡∑ö‡∂ª‡∑ì‡∂∏
    function selectRow(id) {
        selectedId = id;
        document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
        const selectedRow = document.getElementById('row-' + id);
        if (selectedRow) {
            selectedRow.classList.add('selected-row');
        }
    }

    // ‡∂ö‡∑è‡∂ª‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂á‡∂©‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    function addToCart() {
        if (!selectedId) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä ‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∂±‡∑ä‡∂±!");
            return;
        }
        let item = inventory.find(i => i.id === selectedId);
        cart.push({ ...item, discount: 0 });
        updateCartUI();
    }

    // ‡∂ö‡∑è‡∂ª‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂Ö‡∂∫‡∑í‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    function removeFromCart(index) {
        if (confirm("‡∂∏‡∑ô‡∂∏ ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫ ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?")) {
            cart.splice(index, 1);
            updateCartUI();
        }
    }

    // ‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä popup ‡∂ë‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
    function showDiscountPopup() {
        if (cart.length === 0) {
            alert("‡∂ö‡∑è‡∂ª‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∑Ñ‡∑í‡∑É‡∑ä ‡∑Ä‡∑ì ‡∂á‡∂≠!");
            return;
        }
        
        let itemNum = prompt("‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä ‡∂Ø‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫‡∑ö ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (1-" + cart.length + "):");
        itemNum = parseInt(itemNum);
        
        if (itemNum > 0 && itemNum <= cart.length) {
            discountItemIndex = itemNum - 1;
            document.getElementById('discountAmount').value = "";
            document.getElementById('discountPopup').style.display = 'flex';
            document.getElementById('discountAmount').focus();
        } else {
            alert("‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!");
        }
    }

    // ‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    function confirmDiscount() {
        if (discountItemIndex === null) return;
        let discount = parseFloat(document.getElementById('discountAmount').value) || 0;
        
        if (discount < 0) {
            alert("‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä ‡∂ç‡∂´ ‡∂Ö‡∂ú‡∂∫‡∂ö‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö!");
            return;
        }
        
        if (discount > cart[discountItemIndex].price) {
            if (!confirm("‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫‡∑ö ‡∂∏‡∑î‡∑Ö‡∑î ‡∂∏‡∑í‡∂Ω‡∂ß ‡∑Ä‡∂©‡∑è ‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑ö! ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∂Ø?")) {
                return;
            }
        }
        
        cart[discountItemIndex].discount = discount;
        updateCartUI();
        closeDiscountPopup();
    }

    // ‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä popup ‡∑Ä‡∑É‡∂±‡∑ä‡∂±
    function closeDiscountPopup() {
        document.getElementById('discountPopup').style.display = 'none';
        discountItemIndex = null;
    }

    // --- ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä‡∂ö‡∂∏: ‡∂∂‡∑í‡∂Ω ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂± ‡∂ö‡∑ú‡∂ß‡∑É ‡∂¥‡∑í‡∑Ö‡∑í‡∑Ä‡∑ô‡∑Ö‡∂ö‡∂ß ‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ---
    function updateCartUI() {
        const list = document.getElementById('cartList');
        let grossTotal = 0; // ‡∂ã‡∂¥ ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä
        let totalDiscount = 0; // ‡∂∏‡∑î‡∑Ö‡∑î ‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä
        
        list.innerHTML = cart.map((item, idx) => {
            let finalPrice = item.price - item.discount;
            grossTotal += item.price;
            totalDiscount += item.discount;
            
            return `
                <li>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${idx+1}. ${item.name}</div>
                    </div>
                    
                    <div class="cart-item-price-block">
                        ${item.discount > 0 ? 
                            `<span class="original-price-strike">Rs. ${item.price.toFixed(2)}</span>
                             <span class="discount-label">-${item.discount.toFixed(2)}</span>` 
                            : ''}
                        <div class="final-price-display">Rs. ${finalPrice.toFixed(2)}</div>
                    </div>

                    <div class="remove-btn" onclick="removeFromCart(${idx})" title="‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±">‚úï</div>
                </li>`;
        }).join('');
        
        // ‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∂¥‡∑Ñ‡∑Ö ‡∂ö‡∑ú‡∂ß‡∑É)
        let netTotal = grossTotal - totalDiscount;

        document.getElementById('subTotalDisplay').innerText = grossTotal.toFixed(2);
        
        const discountRow = document.getElementById('discountRow');
        const discountDisplay = document.getElementById('discountDisplay');
        
        if (totalDiscount > 0) {
            discountRow.style.display = 'flex';
            discountDisplay.innerText = "-" + totalDiscount.toFixed(2);
        } else {
            discountRow.style.display = 'none';
        }

        document.getElementById('grandTotal').innerText = netTotal.toFixed(2);
    }

    // ‡∂∂‡∑í‡∂Ω ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (Checkout) ‡∑É‡∑Ñ ‡∂ª‡∑í‡∑É‡∑ì‡∂ß‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂± (‡∂¥‡∑í‡∑Ö‡∑í‡∑Ä‡∑ô‡∑Ö‡∂ß)
    function checkout() {
        if (cart.length === 0) {
            alert("‡∂ö‡∑è‡∂ª‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∑Ñ‡∑í‡∑É‡∑ä ‡∑Ä‡∑ì ‡∂á‡∂≠!");
            return;
        }
        
        // Calculate totals
        let grossTotal = 0;
        let totalDiscount = 0;
        let netTotal = 0;
        
        let receiptHTML = `<div style="border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 10px;">
                                <center><strong>CHANDANA STORES</strong></center>
                           </div>`;
        
        cart.forEach((c, idx) => {
            let item = inventory.find(i => i.id === c.id);
            if (item.stock > 0) item.stock--;
            
            let finalAmt = c.price - c.discount;
            grossTotal += c.price;
            totalDiscount += c.discount;
            netTotal += finalAmt;

            // Income stats update
            totalIncome += finalAmt;
            totalProfit += (finalAmt - item.cost);
            
            // Receipt Item Row
            receiptHTML += `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <div>${idx+1}. ${c.name}</div>
                    <div style="text-align: right;">
                        ${c.discount > 0 ? `<small style="text-decoration: line-through; color: #888;">${c.price.toFixed(2)}</small> <br>` : ''}
                        Rs. ${finalAmt.toFixed(2)}
                    </div>
                </div>`;
        });
        
        receiptHTML += `<div style="border-top: 1px dashed var(--border-color); margin-top: 10px; padding-top: 10px;">`;
        
        // Subtotal on Receipt
        receiptHTML += `
            <div style="display: flex; justify-content: space-between;">
                <span>‡∂ã‡∂¥ ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä:</span>
                <span>${grossTotal.toFixed(2)}</span>
            </div>`;
            
        // Discount on Receipt
        if (totalDiscount > 0) {
            receiptHTML += `
            <div style="display: flex; justify-content: space-between; color: var(--discount-color);">
                <span>‡∑Ä‡∂ß‡∑ä‡∂ß‡∂∏‡∑ä:</span>
                <span>-${totalDiscount.toFixed(2)}</span>
            </div>`;
        }

        // Net Total on Receipt
        receiptHTML += `
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; margin-top: 5px; color: var(--main-blue);">
                <span>‡∂ú‡∑ô‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω:</span>
                <span>Rs. ${netTotal.toFixed(2)}</span>
            </div>
        </div>`;

        receiptHTML += `<div style="text-align: center; margin-top: 20px; font-size: 12px;">‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í! ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ë‡∂±‡∑ä‡∂±.</div>`;
        
        // Update stats
        document.getElementById('stats').innerText = `‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏: ${totalIncome.toFixed(2)} | ‡∂Ω‡∑è‡∂∑‡∂∫: ${totalProfit.toFixed(2)}`;
        
        // Show receipt popup
        document.getElementById('receiptDetails').innerHTML = receiptHTML;
        document.getElementById('receiptPopup').style.display = 'flex';
        
        // Clear cart and update storage
        cart = [];
        updateCartUI();
        saveToStorage();
        renderTable();
    }

    // ‡∂ª‡∑í‡∑É‡∑ì‡∂ß‡∑ä popup ‡∑Ä‡∑É‡∂±‡∑ä‡∂±
    function closeReceiptPopup() {
        document.getElementById('receiptPopup').style.display = 'none';
    }

    // Enter key support for popups
    document.addEventListener('keydown', function(event) {
        // Item name popup
        if (document.getElementById('itemNamePopup').style.display === 'flex' && event.key === 'Enter') {
            confirmItemNameChange();
            event.preventDefault();
        }
        // Discount popup
        if (document.getElementById('discountPopup').style.display === 'flex' && event.key === 'Enter') {
            confirmDiscount();
            event.preventDefault();
        }
        // Receipt popup
        if (document.getElementById('receiptPopup').style.display === 'flex' && event.key === 'Enter') {
            closeReceiptPopup();
            event.preventDefault();
        }
    });

    // ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂¥‡∂´ ‡∂ú‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏
    window.onload = initialize;
</script>

</body>
</html>
